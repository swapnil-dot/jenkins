properties([[$class: 'JiraProjectProperty'], gitLabConnection('utopus>_gitlab'), [$class: 'RebuildSettings', autoRebuild: false, rebuildDisabled: false],
   parameters([
     booleanParam(defaultValue: false, description: '', name: 'cleanup'),
     booleanParam(defaultValue: false, description: '', name: 'execute'),
     string(defaultValue: '', description: '', name: 'forecast_runner_tag', trim: false),
     string(defaultValue: '', description: '', name: 'artifact_basepath', trim: false),
     string(defaultValue: '', description: '', name: 'orchestrator_sdk_version', trim: false),
     string(defaultValue: '', description: '', name: 'env-repo-tag', trim: false),
     string(defaultValue: '', description: '', name: 'ensemble_sdk_version', trim: false),
     ])
])
node{
 
 
 def String image_name
 String aws_access_id = ""
 String aws_secret_key = ""
 
 stages {
   stage('Checkout'){
     withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'fx-model-cli',
     usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
       aws_access_id = USERNAME
       aws_secret_key = PASSWORD
     }
     if( !aws_access_id ){
       error("AWS access key is empty or not defined.")
     }
     if( !aws_secret_key ){
       error("AWS secret key is empty or not defined.")
     }
   }
   stage('Execute'){
     if( cleanup.equals('true') ){
       println "Cleanup Selected. SKipping Execute Process."
       sshagent(credentials: ['local-vm-dev-ssh-key']) {
         sh '''
         ssh -T -o StrictHostKeyChecking=no ec2-user@10.32.209.207 <<EOF
         docker stop scoring_development_environment
         docker container prune -f
         <<-EOF
         '''
       }
     }
     else{
         sshagent(credentials: ['local-vm-dev-ssh-key']) {
         sh '''
         ssh -T -o StrictHostKeyChecking=no ec2-user@10.32.209.207 <<EOF
         ls
         pwd
         cd utopus-fx-cli/
         pwd
         git branch
         python3 fx_development_cli.py --action create --forecast_runner_repo  https://fx-ds:q5C7NLzGJZ8fLt8VaBYV@bitbucket.org/utopusinsights/fx_wind_intraday.git --forecast_runner_tag ${forecast_runner_tag} --artifact_basepath ${artifact_basepath} --orchestrator_sdk_version ${orchestrator_sdk_version} --env-repo https://fx-ds:q5C7NLzGJZ8fLt8VaBYV@bitbucket.org/utopusinsights/fx-intraday-local-environment-builder.git --env-repo-tag  ${env-repo-tag} --ensemble_sdk_version  ${ensemble_sdk_version}
         <<-EOF
         '''
         }
     }

   }
  stage('Token'){
    sshagent(credentials: ['local-vm-dev-ssh-key']) {
      sh '''
      ssh -T -o StrictHostKeyChecking=no ec2-user@10.32.209.207 <<EOF
      docker exec -t scoring_development_environment sh -c "jupyter-notebook list"
      <<-EOF
      '''
    }
  }
 }
}
